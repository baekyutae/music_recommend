# v1 성능 평가 보고서 (Myna 추가 버전)

**작성일**: 2025-12-12

이 문서는 **VibeCurator v1** 베이스라인을 유지한 상태에서, Stage3 오디오 인코더만 CNN vs Myna로 교체하여 비교한 결과를 정리한 보고서입니다. 기존 v1 보고서의 평가 세트/지표 정의/하이퍼파라미터를 그대로 사용하되, Stage3를 `stage3_cnn`과 `stage3_myna` 두 버전으로 분리하여 비교 분석합니다.

---

## 1. 평가 데이터·세트 구성

* **Seed 곡 개수**: 1,000개
* **Seed 추출 방식**: 
  * Test 플레이리스트에서 첫 곡을 seed로 사용
  * `IN_CATALOG_SONGS`에 포함된 곡만 사용 (item2vec vocab 기준, min_count=2 이상 등장 곡)
  * 플레이리스트 길이가 2곡 이상인 경우만 평가 케이스로 포함
* **Ground truth 정의**: 
  * 각 플레이리스트에서 seed 곡을 제외한 나머지 곡들을 `target_song_ids`로 정의
  * "같은 플레이리스트에 포함된 다른 곡들"을 정답으로 간주
* **평가 세트 구성**: 
  * 플레이리스트 단위 랜덤 split (80/10/10)
  * Test 세트에서 생성된 evaluation cases 사용
  * 실제 평가는 속도 테스트를 위해 1,000개 샘플로 수행 (`MAX_CASES = 1000`)

---

## 2. 지표 정의

### 2.1 정확도 / 랭킹 품질 지표

* **Recall@K**
  * 정의: 각 seed 곡에 대해 추천 Top-K 안에 원래 같은 플레이리스트에 있던 곡(target_song_ids)이 몇 개나 들어왔는지 비율을 계산하고, 전체 seed에 대해 평균낸 값
  * 수식: `Recall@K = |Recommended_K ∩ target_song_ids| / |target_song_ids|` (seed별 계산 후 평균)
  * K=20 사용

* **nDCG@K (Normalized Discounted Cumulative Gain)**
  * 정의: 정답 곡이 위쪽 순위에 있을수록 높은 점수를 주는 랭킹 품질 지표
  * Binary relevance: 정답 곡이면 rel=1, 아니면 0
  * DCG@K = Σ (rel_i / log2(i+1)) (i는 1부터 K까지 순위)
  * IDCG@K: 이상적인 순서(모든 정답이 위에)일 때의 DCG
  * nDCG@K = DCG@K / IDCG@K
  * K=20 사용

### 2.2 다양성 지표

* **아티스트 다양성 (mean_unique_artists@K)**
  * 정의: 추천 Top-K 안에서 서로 다른 아티스트 수를 각 seed별로 계산하고, 전체 seed에 대해 평균낸 값
  * 높을수록 다양한 아티스트가 추천됨을 의미

* **장르 다양성 (mean_unique_genres@K)**
  * 정의: 추천 Top-K 안에서 서로 다른 메인 장르 수를 각 seed별로 계산하고, 전체 seed에 대해 평균낸 값
  * 높을수록 다양한 장르가 추천됨을 의미

### 2.3 UX / 편중·안전성 지표

* **최대 아티스트 점유율 (mean_max_artist_share@K)**
  * 정의: 각 seed별로 Top-K 추천 리스트에서 가장 많이 나온 아티스트의 곡 개수를 K로 나눈 비율을 계산하고, 전체 seed에 대해 평균낸 값
  * 낮을수록 아티스트 편중이 완화됨을 의미 (예: Top10에서 아이유 7곡이면 0.7)

* **Seed-Genre 일관성 비율 (mean_seed_genre_ratio@K)**
  * 정의: 각 seed별로 Top-K 추천 리스트에서 seed 곡과 같은 메인 장르를 가진 곡의 비율을 계산하고, 전체 seed에 대해 평균낸 값
  * 높을수록 seed 장르와 일관된 추천을 의미

* **Catalog Coverage@K (coverage@20)**
  * 정의: 전체 in-catalog 곡 중, 평가 시 Top-K 추천 결과에 한 번이라도 등장한 곡의 비율
  * 수식: `coverage@K = |{unique recommended songs in all Top-K}| / |IN_CATALOG_SONGS|`
  * 높을수록 카탈로그 전반에 걸쳐 다양한 곡이 추천됨을 의미

---

## 3. v1 수치 요약 (Stage별 비교)

| 모델 스테이지 | Recall@20 | nDCG@20 | 아티스트 다양성@20 | 장르 다양성@20 | 최대 아티스트 점유율@20 | Seed-Genre 일관성@20 | Coverage@20 | 비고 |
|--------------|----------|---------|-------------------|---------------|----------------------|---------------------|-------------|------|
| stage1       | 0.031292 | 0.057232 | 15.011            | 3.814         | 0.20180               | 0.56950              | 0.054152 | item2vec CF만 사용 |
| stage1_5     | 0.025331 | 0.050087 | 16.844            | 3.280         | 0.09720               | 0.67765              | 0.053874 | CF + 메타(아티스트/장르 레일가드) |
| stage3_cnn   | 0.025150 | 0.048535 | 17.020            | 3.316         | 0.09675               | 0.67205              | 0.053716 | CF + 메타 + 오디오 하이브리드 (CNN) |
| stage3_myna  | 0.024958 | 0.048284 | 17.133            | 3.357         | 0.09635               | 0.66880              | 0.053659 | CF + 메타 + 오디오 하이브리드 (Myna) |

**주요 변화 요약:**

* **Recall@20**: 
  * Stage1 → Stage1.5에서 소폭 하락 (0.031292 → 0.025331)
  * Stage1.5 → Stage3(CNN/Myna)에서 거의 유지 (0.025150 / 0.024958)
  * Stage3 CNN vs Myna: Myna가 약간 낮음 (차이: -0.000192, 매우 작음)

* **nDCG@20**: 
  * Stage1 → Stage1.5에서 소폭 하락 (0.057232 → 0.050087)
  * Stage1.5 → Stage3(CNN/Myna)에서 약간 하락 (0.048535 / 0.048284)
  * Stage3 CNN vs Myna: Myna가 약간 낮음 (차이: -0.000251, 매우 작음)

* **아티스트 다양성**: 
  * Stage1 → Stage1.5에서 개선 (15.011 → 16.844)
  * Stage1.5 → Stage3(CNN/Myna)에서 추가 개선 (17.020 / 17.133)
  * Stage3 CNN vs Myna: Myna가 약간 높음 (차이: +0.113)

* **장르 다양성**: 
  * Stage1 → Stage1.5에서 약간 하락 (3.814 → 3.280)
  * Stage1.5 → Stage3(CNN/Myna)에서 소폭 회복 (3.316 / 3.357)
  * Stage3 CNN vs Myna: Myna가 약간 높음 (차이: +0.041)

* **최대 아티스트 점유율**: 
  * Stage1 → Stage1.5에서 크게 개선 (0.20180 → 0.09720)
  * Stage1.5 → Stage3(CNN/Myna)에서 거의 유지 (0.09675 / 0.09635)
  * Stage3 CNN vs Myna: Myna가 약간 낮음 (차이: -0.000400, 매우 작음)

* **Seed-Genre 일관성**: 
  * Stage1 → Stage1.5에서 개선 (0.56950 → 0.67765)
  * Stage1.5 → Stage3(CNN/Myna)에서 약간 하락 (0.67205 / 0.66880)
  * Stage3 CNN vs Myna: Myna가 약간 낮음 (차이: -0.003250)

* **Coverage@20**: 
  * Stage1 → Stage1.5에서 거의 유지 (0.054152 → 0.053874)
  * Stage1.5 → Stage3(CNN/Myna)에서 거의 유지 (0.053716 / 0.053659)
  * Stage3 CNN vs Myna: Myna가 약간 낮음 (차이: -0.000057, 매우 작음)

**인사이트**: 
* Stage1.5에서 메타데이터 re-ranking을 통해 아티스트 편중이 크게 완화되고 장르 일관성이 개선되었으나, Recall은 소폭 하락.
* Stage3(CNN/Myna)에서는 오디오 임베딩을 추가했지만 Recall/nDCG는 추가 하락, 다양성은 소폭 개선.
* **Stage3 CNN vs Myna 비교**: 정량 지표상 차이는 매우 작으며, Myna가 다양성 일부 지표(아티스트/장르 다양성)에서는 약간 높지만, recall/ndcg는 약간 낮음. 전체적으로 "거의 비슷한 성능"으로 평가됨.

---

## 4. 대표 seed 기반 정성 비교 요약

### 4.1 Seed: 꽃송이가 - 버스커 버스커 (song_id=25012)

#### Stage1 (CF-only) - Top 8

| 순위 | Song ID | 곡명 | 아티스트 | 장르 |
|------|---------|------|----------|------|
| 1 | 132994 | 벚꽃 엔딩 | 버스커 버스커 | GN0600 |
| 2 | 532876 | 첫사랑 | 버스커 버스커 | GN0600 |
| 3 | 640328 | 골목길 어귀에서 | 버스커 버스커 | GN0600 |
| 4 | 173846 | 이상형 | 버스커 버스커 | GN0600 |
| 5 | 36397 | Spring | 2AM | GN0100 |
| 6 | 628489 | 향수 | 버스커 버스커 | GN0600 |
| 7 | 104065 | 봄바람 | 버스커 버스커 | GN0600 |
| 8 | 684530 | 봄이 오면 | 브로콜리너마저 | GN0500 |

#### Stage1.5 (CF+Meta) - Top 8

| 순위 | Song ID | 곡명 | 아티스트 | 장르 |
|------|---------|------|----------|------|
| 1 | 132994 | 벚꽃 엔딩 | 버스커 버스커 | GN0600 |
| 2 | 532876 | 첫사랑 | 버스커 버스커 | GN0600 |
| 3 | 36397 | Spring | 2AM | GN0100 |
| 4 | 684530 | 봄이 오면 | 브로콜리너마저 | GN0500 |
| 5 | 89331 | 봄이 왔어요 | 솔솔부는 봄바람 | GN0500 |
| 6 | 516186 | 벚꽃이 내린다 | 소란 (SORAN) | GN0500 |
| 7 | 336475 | Beautiful Day | 어반자카파 | GN0100 |
| 8 | 41114 | 소풍 (Intro) | 유승우 | GN0600 |

#### Stage3-CNN (CF+Meta+Audio) - Top 8

| 순위 | Song ID | 곡명 | 아티스트 | 장르 |
|------|---------|------|----------|------|
| 1 | 132994 | 벚꽃 엔딩 | 버스커 버스커 | GN0600 |
| 2 | 532876 | 첫사랑 | 버스커 버스커 | GN0600 |
| 3 | 395438 | 복숭아 | 아이유 | GN0100 |
| 4 | 235215 | 바로 너였어 (With 알렉스) | 장나라 | GN0100 |
| 5 | 620195 | The Romantic | 투개월 | GN1500 |
| 6 | 8710 | 봄이왔다 | 타루 | GN0500 |
| 7 | 241698 | 봄 | 랄라스윗 (lalasweet) | GN0500 |
| 8 | 36397 | Spring | 2AM | GN0100 |

#### Stage3-Myna (CF+Meta+Audio) - Top 8

| 순위 | Song ID | 곡명 | 아티스트 | 장르 |
|------|---------|------|----------|------|
| 1 | 132994 | 벚꽃 엔딩 | 버스커 버스커 | GN0600 |
| 2 | 532876 | 첫사랑 | 버스커 버스커 | GN0600 |
| 3 | 613335 | Good Day | 존박 | GN0100 |
| 4 | 8710 | 봄이왔다 | 타루 | GN0500 |
| 5 | 241698 | 봄 | 랄라스윗 (lalasweet) | GN0500 |
| 6 | 655561 | 첫 데이트 | 스윗소로우 (SWEET SORROW) | GN0100 |
| 7 | 410420 | 니가 필요해 (I Need You) | 케이윌 | GN0100 |
| 8 | 395438 | 복숭아 | 아이유 | GN0100 |

### 4.2 정성 비교 인사이트

* **Stage1 (CF-only)**: 
  * 동일 아티스트(버스커 버스커) 편중이 심함 (Top 8 중 6곡이 버스커 버스커)
  * CF 점수만으로는 "같이 듣는 패턴"이 강하게 반영되어 아티스트 다양성이 낮음

* **Stage1.5 (CF+Meta)**: 
  * 메타데이터 re-ranking(아티스트 페널티, 장르 레일가드)으로 편중이 완화됨
  * 버스커 버스커는 상위 2곡만 남고, 다양한 아티스트(2AM, 브로콜리너마저, 소란, 어반자카파 등)가 등장
  * Seed 장르 일관성(GN0600)이 높아짐

* **Stage3-CNN (CF+Meta+Audio)**: 
  * 오디오 임베딩이 반영되어 순위가 재조정됨
  * 버스커 버스커 상위 2곡은 유지되나, 그 이후 순위에서 오디오 유사도 기반 곡들(복숭아-아이유, 바로 너였어-장나라 등)이 상승
  * CF 기반 정답 맞추기 지표를 크게 올리진 못했고, 일부 seed에서 방향성이 흔들릴 수 있음

* **Stage3-Myna (CF+Meta+Audio)**: 
  * CNN과 유사한 패턴이지만, 구체적인 곡 리스트는 다름
  * 버스커 버스커 상위 2곡은 유지되나, 그 이후 순위에서 Myna 임베딩 기반 곡들(Good Day-존박, 첫 데이트-스윗소로우 등)이 등장
  * **CNN vs Myna**: 리스트가 달라지긴 하지만, 오프라인 지표 상 큰 차이는 없다는 결론

**전체 패턴**: Stage1.5의 메타데이터 re-ranking이 아티스트 편중 완화와 장르 일관성 개선에 효과적. Stage3의 오디오 하이브리드는 순위 재조정에 기여하나 정량 지표 개선은 제한적. CNN과 Myna는 추천 리스트 구성은 다르지만, 정량 지표상 거의 비슷한 성능을 보임.

---

## 5. v1에서 사용한 핵심 하이퍼파라미터 요약

### 5.1 Stage1 (item2vec)

* `min_count = 2`: 최소 출현 횟수 (2회 미만 곡은 vocab에서 제외)
* `window = 10`: 컨텍스트 윈도우 크기
* `vector_size = 128`: 임베딩 차원
* `epochs = 5`: 학습 에폭 수
* `negative = 10`: Negative sampling 개수
* `sg = 1`: Skip-gram 모드 사용
* `hs = 0`: Hierarchical softmax 미사용

### 5.2 Stage1.5 재랭킹

* **CF 후보 추출**: `topn_cf = 200` (item2vec에서 상위 200곡 후보 추출)
* **동일 아티스트 soft penalty**:
  * `max_per_artist_soft = 3`: 아티스트당 최대 3곡까지 페널티 없음
  * `penalty_per_extra = 0.05`: 3곡 초과 시 곡당 0.05씩 점수 차감
* **장르 레일가드**:
  * `offrail_penalty_general = 0.008`: 일반 장르 불일치 시 페널티
  * `offrail_penalty_special = 0.03`: 특수 장르(트로트, CCM 등) 불일치 시 페널티
* **최종 아티스트 hardcut**:
  * `max_per_artist_final = 2`: 최종 Top-K에서 아티스트당 최대 2곡만 허용
  * `topk_final = 30`: 최종 반환 곡 수 (평가 시에는 topk=20으로 재슬라이싱)

### 5.3 Stage3 하이브리드

* **CF+메타 점수 vs 오디오 점수 가중치**:
  * `alpha = 0.7`: CF+메타 정규화 점수 가중치
  * `beta = 0.3`: 오디오 유사도 정규화 점수 가중치
* **CF 후보 개수**: `topn_cf = 200` (Stage1.5와 동일)
* **하이브리드 점수 계산**:
  * CF+메타 점수와 오디오 유사도를 각각 min-max 정규화 (0~1 범위)
  * `score_hybrid = alpha * score_cf_norm + beta * score_audio_norm`
  * 오디오 임베딩이 없는 곡은 `score_audio_norm = 0.0`으로 처리
* **오디오 임베딩 소스**:
  * **Stage3-CNN**: `audio_embeddings_stage2.npz` 사용 (CNN 기반 오디오 인코더, dim=128)
  * **Stage3-Myna**: `audio_embeddings_myna_stage2.npz` 사용 (Myna 기반 오디오 인코더, dim=384)

---

## 6. 결론 및 다음 액션

### 6.1 주요 결론

* **오디오 임베딩의 역할**: 오디오 임베딩은 단독 성능이 아니라 CF를 보조하는 축으로 작동함. Stage3에서 오디오를 추가했을 때 Recall/nDCG는 오히려 소폭 하락했으나, 다양성 지표는 소폭 개선됨.

* **CNN vs Myna 비교**: 
  * 정량 지표상 차이는 매우 작음 (recall 차이: -0.000192, ndcg 차이: -0.000251)
  * Myna가 다양성 일부 지표(아티스트/장르 다양성)에서는 약간 높지만, recall/ndcg는 약간 낮음
  * 추천 리스트 구성은 다르지만, 전체적으로 "거의 비슷한 성능"으로 평가됨
  * **결론**: 현재 평가 세트/지표 기준으로는 CNN과 Myna 중 어느 것을 선택하더라도 성능 차이는 미미함

### 6.2 다음 실험 제안

1. **Beta 스윕 실험**: 
   * 현재 `alpha=0.7, beta=0.3` 고정값에서, beta를 0.1~0.5 범위로 변경하여 오디오 가중치가 지표에 미치는 영향을 측정
   * 특히 recall/ndcg vs 다양성 지표 간 trade-off를 확인

2. **Tie-break 방식 개선**: 
   * 현재는 CF+메타 점수와 오디오 점수를 단순 가중합으로 결합
   * CF 점수가 비슷한 곡들 간 순위 결정 시 오디오 유사도를 tie-break로만 사용하는 방식도 고려

3. **Audio 적용 후보군 제한**: 
   * 현재는 CF+메타 후보 200곡 전체에 오디오 점수를 적용
   * CF 점수 상위 N곡(예: 50곡)에만 오디오 점수를 적용하여 "CF가 이미 필터링한 후보"에만 오디오 보정을 가하는 방식도 고려

4. **정성 평가 확대**: 
   * 현재는 1개 seed(꽃송이가)만 정성 비교
   * 다양한 장르/아티스트 seed에 대해 CNN vs Myna 추천 리스트를 비교하여, 정량 지표로는 드러나지 않는 차이(예: 특정 장르에서의 성능 차이)를 발견

---

## 7. 향후 버전 비교 시 활용 계획

이 문서는 **v1 기준선 (Myna 추가 버전)**이며, 이후 Stage2/3 구조·가중치·데이터를 바꾼 v2/v3를 만들었을 때, 같은 평가 세트/지표로 다시 측정해 이 표/정의와 직접 비교할 계획입니다.

정량 지표(Recall@K, nDCG@K, 다양성 지표, Coverage@K 등)뿐 아니라, 정성 비교도 v2/v3 버전으로 추가해서 **"숫자 + 실제 추천 리스트" 모두로 개선 여부를 판단**할 예정입니다.

주요 비교 포인트:
* 하이퍼파라미터 변경(예: alpha/beta 비율, penalty 값)이 지표에 미치는 영향
* 오디오 인코더 모델 변경(예: CNN vs Myna, 아키텍처, 학습 방식)이 추천 품질에 미치는 영향
* 새로운 re-ranking 규칙 추가 시 정량/정성 지표 변화

