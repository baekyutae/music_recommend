# v1 성능 평가 보고서

이 문서는 **VibeCurator v1** 기준으로, Stage1(item2vec), Stage1.5(CF+메타데이터 re-ranking), Stage3(CF+메타+오디오 하이브리드)의 **오프라인 평가 설정과 결과를 정리한 베이스라인 문서**입니다. 이후 v2/v3와 비교할 때 기준점으로 사용할 계획입니다.

---

## 1. 평가 데이터·세트 구성

* **Seed 곡 개수**: 1,000개
* **Seed 추출 방식**: 
  * Test 플레이리스트에서 첫 곡을 seed로 사용
  * `IN_CATALOG_SONGS`에 포함된 곡만 사용 (item2vec vocab 기준, min_count=2 이상 등장 곡)
  * 플레이리스트 길이가 2곡 이상인 경우만 평가 케이스로 포함
* **Ground truth 정의**: 
  * 각 플레이리스트에서 seed 곡을 제외한 나머지 곡들을 `target_song_ids`로 정의
  * "같은 플레이리스트에 포함된 다른 곡들"을 정답으로 간주
* **평가 세트 구성**: 
  * 플레이리스트 단위 랜덤 split (80/10/10)
  * Test 세트에서 생성된 evaluation cases 사용
  * 실제 평가는 속도 테스트를 위해 1,000개 샘플로 수행 (`MAX_CASES = 1000`)

---

## 2. 지표 정의

### 2.1 정확도 / 랭킹 품질 지표

* **Recall@K**
  * 정의: 각 seed 곡에 대해 추천 Top-K 안에 원래 같은 플레이리스트에 있던 곡(target_song_ids)이 몇 개나 들어왔는지 비율을 계산하고, 전체 seed에 대해 평균낸 값
  * 수식: `Recall@K = |Recommended_K ∩ target_song_ids| / |target_song_ids|` (seed별 계산 후 평균)
  * K=20 사용

* **nDCG@K (Normalized Discounted Cumulative Gain)**
  * 정의: 정답 곡이 위쪽 순위에 있을수록 높은 점수를 주는 랭킹 품질 지표
  * Binary relevance: 정답 곡이면 rel=1, 아니면 0
  * DCG@K = Σ (rel_i / log2(i+1)) (i는 1부터 K까지 순위)
  * IDCG@K: 이상적인 순서(모든 정답이 위에)일 때의 DCG
  * nDCG@K = DCG@K / IDCG@K
  * K=20 사용

### 2.2 다양성 지표

* **아티스트 다양성 (mean_unique_artists@K)**
  * 정의: 추천 Top-K 안에서 서로 다른 아티스트 수를 각 seed별로 계산하고, 전체 seed에 대해 평균낸 값
  * 높을수록 다양한 아티스트가 추천됨을 의미

* **장르 다양성 (mean_unique_genres@K)**
  * 정의: 추천 Top-K 안에서 서로 다른 메인 장르 수를 각 seed별로 계산하고, 전체 seed에 대해 평균낸 값
  * 높을수록 다양한 장르가 추천됨을 의미

### 2.3 UX / 편중·안전성 지표

* **최대 아티스트 점유율 (mean_max_artist_share@K)**
  * 정의: 각 seed별로 Top-K 추천 리스트에서 가장 많이 나온 아티스트의 곡 개수를 K로 나눈 비율을 계산하고, 전체 seed에 대해 평균낸 값
  * 낮을수록 아티스트 편중이 완화됨을 의미 (예: Top10에서 아이유 7곡이면 0.7)

* **Seed-Genre 일관성 비율 (mean_seed_genre_ratio@K)**
  * 정의: 각 seed별로 Top-K 추천 리스트에서 seed 곡과 같은 메인 장르를 가진 곡의 비율을 계산하고, 전체 seed에 대해 평균낸 값
  * 높을수록 seed 장르와 일관된 추천을 의미

---

## 3. v1 수치 요약 (Stage별 비교)

| 모델 스테이지 | Recall@20 | nDCG@20 | 아티스트 다양성@20 | 장르 다양성@20 | 최대 아티스트 점유율@20 | Seed-Genre 일관성@20 | 비고 |
|--------------|----------|---------|-------------------|---------------|----------------------|---------------------|------|
| Stage1       | 0.0313   | 0.0572  | 15.011            | 3.814         | 0.2018               | 0.5695              | item2vec CF만 사용 |
| Stage1.5     | 0.0253   | 0.0501  | 16.844            | 3.280         | 0.0972               | 0.6781              | CF + 메타(아티스트/장르 레일가드) |
| Stage3       | 0.0251   | 0.0485  | 17.020            | 3.316         | 0.0968               | 0.6725              | CF + 메타 + 오디오 하이브리드 |

**주요 변화 요약:**

* **Recall@20**: Stage1 → Stage1.5에서 소폭 하락 (0.0313 → 0.0253), Stage3에서 거의 유지 (0.0251)
* **nDCG@20**: Stage1 → Stage1.5에서 소폭 하락 (0.0572 → 0.0501), Stage3에서 약간 하락 (0.0485)
* **아티스트 다양성**: Stage1 → Stage1.5에서 개선 (15.011 → 16.844), Stage3에서 추가 개선 (17.020)
* **장르 다양성**: Stage1 → Stage1.5에서 약간 하락 (3.814 → 3.280), Stage3에서 소폭 회복 (3.316)
* **최대 아티스트 점유율**: Stage1 → Stage1.5에서 크게 개선 (0.2018 → 0.0972), Stage3에서 거의 유지 (0.0968)
* **Seed-Genre 일관성**: Stage1 → Stage1.5에서 개선 (0.5695 → 0.6781), Stage3에서 약간 하락 (0.6725)

**인사이트**: Stage1.5에서 메타데이터 re-ranking을 통해 아티스트 편중이 크게 완화되고 장르 일관성이 개선되었으나, Recall은 소폭 하락. Stage3에서는 오디오 임베딩을 추가했지만 Recall/nDCG는 추가 하락, 다양성은 소폭 개선.

---

## 4. 대표 seed 기반 정성 비교 요약

`v1_추천 결과물 비교.md`에서 확인한 4개 seed 곡(로켓트-잔나비, 와리가리-혁오, 삐삐-아이유, Illumination-SEKAI NO OWARI)에 대한 패턴 요약:

* **발라드/록 계열 seed (로켓트, 와리가리)**:
  * Stage1에서는 같은 아티스트 위주 추천이 많았으나 (예: 혁오 seed에서 혁오 곡 4곡 상위권)
  * Stage1.5에서 아티스트가 다양해지고 장르 일관성은 유지됨
  * Stage3에서는 오디오 유사도가 반영되어 순위가 재조정되지만, 전체적인 다양성은 유지

* **팝/K-pop seed (삐삐-아이유)**:
  * Stage1에서 다양한 아티스트가 추천되었으나 장르가 혼재 (GN2500, GN0400, GN0100 등)
  * Stage1.5에서 장르 일관성은 유지되나 순위 변화는 적음
  * Stage3에서 오디오 기반 재랭킹이 일부 반영되어 순위가 재조정됨

* **일본 음악 seed (Illumination-SEKAI NO OWARI)**:
  * Stage1.5에서 장르 레일가드가 작동하여 일본 음악(GN1900) 위주로 재정렬됨
  * Stage3에서도 오디오 유사도가 반영되어 일본 음악 위주 추천 유지

**전체 패턴**: Stage1.5의 메타데이터 re-ranking이 아티스트 편중 완화와 장르 일관성 개선에 효과적. Stage3의 오디오 하이브리드는 순위 재조정에 기여하나 정량 지표 개선은 제한적.

---

## 5. v1에서 사용한 핵심 하이퍼파라미터 요약

### 5.1 Stage1 (item2vec)

* `min_count = 2`: 최소 출현 횟수 (2회 미만 곡은 vocab에서 제외)
* `window = 10`: 컨텍스트 윈도우 크기
* `vector_size = 128`: 임베딩 차원
* `epochs = 5`: 학습 에폭 수
* `negative = 10`: Negative sampling 개수
* `sg = 1`: Skip-gram 모드 사용
* `hs = 0`: Hierarchical softmax 미사용

### 5.2 Stage1.5 재랭킹

* **CF 후보 추출**: `topn_cf = 200` (item2vec에서 상위 200곡 후보 추출)
* **동일 아티스트 soft penalty**:
  * `max_per_artist_soft = 3`: 아티스트당 최대 3곡까지 페널티 없음
  * `penalty_per_extra = 0.05`: 3곡 초과 시 곡당 0.05씩 점수 차감
* **장르 레일가드**:
  * `offrail_penalty_general = 0.008`: 일반 장르 불일치 시 페널티
  * `offrail_penalty_special = 0.03`: 특수 장르(트로트, CCM 등) 불일치 시 페널티
* **최종 아티스트 hardcut**:
  * `max_per_artist_final = 2`: 최종 Top-K에서 아티스트당 최대 2곡만 허용
  * `topk_final = 30`: 최종 반환 곡 수 (평가 시에는 topk=20으로 재슬라이싱)

### 5.3 Stage3 하이브리드

* **CF+메타 점수 vs 오디오 점수 가중치**:
  * `alpha = 0.7`: CF+메타 정규화 점수 가중치
  * `beta = 0.3`: 오디오 유사도 정규화 점수 가중치
* **CF 후보 개수**: `topn_cf = 200` (Stage1.5와 동일)
* **하이브리드 점수 계산**:
  * CF+메타 점수와 오디오 유사도를 각각 min-max 정규화 (0~1 범위)
  * `score_hybrid = alpha * score_cf_norm + beta * score_audio_norm`
  * 오디오 임베딩이 없는 곡은 `score_audio_norm = 0.0`으로 처리

---

## 6. 향후 버전 비교 시 활용 계획

이 문서는 **v1 기준선**이며, 이후 Stage2/3 구조·가중치·데이터를 바꾼 v2/v3를 만들었을 때, 같은 평가 세트/지표로 다시 측정해 이 표/정의와 직접 비교할 계획입니다.

정량 지표(Recall@K, nDCG@K, 다양성 지표 등)뿐 아니라, `v1_추천 결과물 비교.md`와 같은 정성 비교도 v2/v3 버전으로 추가해서 **"숫자 + 실제 추천 리스트" 모두로 개선 여부를 판단**할 예정입니다.

주요 비교 포인트:
* 하이퍼파라미터 변경(예: alpha/beta 비율, penalty 값)이 지표에 미치는 영향
* 오디오 인코더 모델 변경(예: 아키텍처, 학습 방식)이 추천 품질에 미치는 영향
* 새로운 re-ranking 규칙 추가 시 정량/정성 지표 변화

